<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crucible PROP</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #0f0500;
      color: #f5f5f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      text-align: center;
      min-height: 100vh;
    }
    h1 {
      font-size: 28px;
      margin: 0 0 8px;
      text-shadow: 0 0 15px #ff6600;
      color: #ff6600;
    }
    .subtitle {
      color: #ffcc99;
      margin: 0 0 15px;
      font-size: 16px;
    }
    .discount-banner {
      color: #ffcc00;
      font-size: 20px;
      font-weight: bold;
      margin: 0 0 25px;
      text-shadow: 0 0 12px #ff6600;
      background: rgba(255, 102, 0, 0.15);
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ff6600;
    }
    .tiers {
      display: flex;
      flex-direction: column;
      gap: 18px;
      max-width: 340px;
      margin: 0 auto 40px;
    }
    .tier {
      background: linear-gradient(135deg, #1a0f00, #221a00);
      border: 2px solid #ff6600;
      border-radius: 16px;
      padding: 24px;
      font-size: 22px;
      font-weight: bold;
      color: #fffaf0;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
      transition: all 0.3s ease;
    }
    .tier:hover {
      transform: scale(1.06);
      box-shadow: 0 0 40px rgba(255, 102, 0, 0.9);
      border-color: #ff9933;
    }
    .tier span {
      display: block;
      font-size: 15px;
      color: #ffcc99;
      margin-top: 8px;
      font-weight: normal;
    }
    .original-price {
      color: #ff9999;
      text-decoration: line-through;
      font-size: 18px;
      margin-right: 8px;
    }
    #payment, #success, #timeout {
      display: none;
      margin-top: 40px;
    }
    .wallet {
      background: #111;
      padding: 20px;
      border-radius: 12px;
      margin: 25px auto;
      max-width: 90%;
      word-break: break-all;
      font-family: monospace;
      font-size: 18px;
      line-height: 1.6;
      border: 2px solid #ff6600;
      color: #f5f5f0;
      box-shadow: 0 0 20px rgba(255, 102, 0, 0.6);
    }
    #qr img {
      max-width: 230px;
      margin: 30px auto;
      display: block;
      border: 3px solid #ff6600;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(255, 102, 0, 0.8);
    }
    .warning {
      color: #ff9933;
      font-weight: bold;
      margin: 20px 0;
      font-size: 15px;
    }
    .timer {
      color: #ffcc99;
      font-size: 15px;
      margin-top: 20px;
      font-weight: bold;
    }
    .success-text {
      color: #ffcc00;
      font-weight: bold;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>Crucible PROP</h1>
  
  <div class="discount-banner">ðŸ”¥ 30% DISCOUNT â€” LIMITED TIME ONLY ðŸ”¥</div>
  
  <p class="subtitle">Pay 70% today â†’ still get full funded account + same payout</p>

  <div class="tiers" id="tiers">
    <div class="tier" onclick="pick(14, 200, 500, 220)">
      <span class="original-price">$20</span>$14 â†’ $200 Account
      <span>Target $500 Â· Payout $220 (30% OFF!)</span>
    </div>
    <div class="tier" onclick="pick(21, 300, 750, 330)">
      <span class="original-price">$30</span>$21 â†’ $300 Account
      <span>Target $750 Â· Payout $330 (30% OFF!)</span>
    </div>
    <div class="tier" onclick="pick(28, 400, 1000, 440)">
      <span class="original-price">$40</span>$28 â†’ $400 Account
      <span>Target $1000 Â· Payout $440 (30% OFF!)</span>
    </div>
    <div class="tier" onclick="pick(35, 500, 1250, 550)">
      <span class="original-price">$50</span>$35 â†’ $500 Account
      <span>Target $1250 Â· Payout $550 (30% OFF!)</span>
    </div>
  </div>

  <!-- PAYMENT SCREEN -->
  <div id="payment">
    <h2>Send exactly <span id="amount" style="color:#ffcc00;"></span> in SOL 
      <small style="color:#ffcc99;">(30% discount applied)</small>
    </h2>
    <div class="wallet" id="wallet">Loading...</div>
    <div id="qr"></div>
    <p class="warning">Use Phantom, Solflare, Backpack, or any Solana wallet</p>
    <p>Payment is detected automatically within seconds</p>
    <p class="success-text">You're saving 30% â€” great choice!</p>
    <div class="timer" id="timer">Time remaining: 15:00</div>
  </div>

  <!-- SUCCESS SCREEN -->
  <div id="success">
    <h2 style="color:#ff6600;">FUNDED ACCOUNT ACTIVATED!</h2>
    <p style="font-size: 18px; line-height: 1.6;">
      Your <strong style="color:#ffcc00;">$<span id="bal"></span></strong> challenge is now live.<br><br>
      Return to the bot and paste any Solana token contract address to start trading.
    </p>
    <p style="color:#aaa; font-size:14px; margin-top:50px;">
      Window closing automatically in 8 seconds...
    </p>
  </div>

  <!-- TIMEOUT SCREEN -->
  <div id="timeout">
    <h2 style="color:#ff6600;">Payment Timeout</h2>
    <p>No confirmed payment received within 15 minutes.</p>
    <p>Refresh the page or try again later.</p>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const PAYMENT_WALLET = "B4427oKJc3xnQf91kwXHX27u1SsVyB8GDQtc3NBxRtkK";
    document.getElementById('wallet').textContent = PAYMENT_WALLET;

    let selected = null;
    let intervalId = null;
    let timeoutId = null;
    let startTime = null;

    async function pick(pay, balance, target, bounty) {
      selected = { pay, balance, target, bounty };

      document.getElementById('amount').textContent = '$' + pay;
      document.getElementById('bal').textContent = balance;

      document.getElementById('tiers').style.display = 'none';
      document.getElementById('payment').style.display = 'block';

      // Solana Pay URL with fixed USD amount
      const solanaPayUrl = `solana:${PAYMENT_WALLET}?amount=${pay}&label=Crucible%20PROP&message=Purchase%20%24${pay}%20Challenge%20(30%25%20OFF)`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=230x230&data=${encodeURIComponent(solanaPayUrl)}`;

      const img = new Image();
      img.src = qrUrl;
      img.onload = () => {
        document.getElementById('qr').innerHTML = '';
        document.getElementById('qr').appendChild(img);
      };

      // Start timer
      startTime = Date.now();
      updateTimer();

      // Notify backend (unchanged)
      await fetch('https://prop-degen-11.onrender.com', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: tg.initDataUnsafe.user?.id,
          payAmount: pay
        })
      }).catch(() => {});

      // Poll for payment
      intervalId = setInterval(checkPayment, 4000);

      // 15-minute timeout
      timeoutId = setTimeout(() => {
        clearInterval(intervalId);
        document.getElementById('payment').style.display = 'none';
        document.getElementById('timeout').style.display = 'block';
      }, 15 * 60 * 1000);
    }

    function updateTimer() {
      if (!startTime) return;
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const remaining = Math.max(0, 900 - elapsed);
      const mins = String(Math.floor(remaining / 60)).padStart(2, '0');
      const secs = String(remaining % 60).padStart(2, '0');
      document.getElementById('timer').textContent = `Time remaining: ${mins}:${secs}`;

      if (remaining > 0) {
        requestAnimationFrame(updateTimer);
      } else {
        document.getElementById('timer').textContent = 'Time remaining: 00:00';
      }
    }

    async function checkPayment() {
      if (!selected || !tg.initDataUnsafe?.user) return;

      try {
        const res = await fetch('https://prop-degen-11.onrender.com', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: tg.initDataUnsafe.user.id,
            payAmount: selected.pay
          })
        });

        const data = await res.json();

        if (data.ok) {
          clearInterval(intervalId);
          clearTimeout(timeoutId);

          document.getElementById('payment').style.display = 'none';
          document.getElementById('success').style.display = 'block';

          setTimeout(() => tg.close(), 8000);
        }
      } catch (e) {
        console.error('Polling error:', e);
      }
    }
  </script>
</body>
</html>
